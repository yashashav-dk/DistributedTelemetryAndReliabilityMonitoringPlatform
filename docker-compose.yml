x-edge-node: &edge-node
  build: ./edge-node
  restart: unless-stopped
  networks:
    - monitoring
  healthcheck:
    test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
    interval: 5s
    timeout: 3s
    retries: 3

services:
  edge-node-1:
    <<: *edge-node
    container_name: edge-node-1
    environment:
      NODE_ID: "1"
    ports:
      - "8001:8000"

  edge-node-2:
    <<: *edge-node
    container_name: edge-node-2
    environment:
      NODE_ID: "2"
    ports:
      - "8002:8000"

  edge-node-3:
    <<: *edge-node
    container_name: edge-node-3
    environment:
      NODE_ID: "3"
    ports:
      - "8003:8000"

  edge-node-4:
    <<: *edge-node
    container_name: edge-node-4
    environment:
      NODE_ID: "4"
    ports:
      - "8004:8000"

  edge-node-5:
    <<: *edge-node
    container_name: edge-node-5
    environment:
      NODE_ID: "5"
    ports:
      - "8005:8000"

  edge-node-6:
    <<: *edge-node
    container_name: edge-node-6
    environment:
      NODE_ID: "6"
    ports:
      - "8006:8000"

  edge-node-7:
    <<: *edge-node
    container_name: edge-node-7
    environment:
      NODE_ID: "7"
    ports:
      - "8007:8000"

  edge-node-8:
    <<: *edge-node
    container_name: edge-node-8
    environment:
      NODE_ID: "8"
    ports:
      - "8008:8000"

  edge-node-9:
    <<: *edge-node
    container_name: edge-node-9
    environment:
      NODE_ID: "9"
    ports:
      - "8009:8000"

  edge-node-10:
    <<: *edge-node
    container_name: edge-node-10
    environment:
      NODE_ID: "10"
    ports:
      - "8010:8000"

  edge-node-11:
    <<: *edge-node
    container_name: edge-node-11
    environment:
      NODE_ID: "11"
    ports:
      - "8011:8000"

  edge-node-12:
    <<: *edge-node
    container_name: edge-node-12
    environment:
      NODE_ID: "12"
    ports:
      - "8012:8000"

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=24h"
    networks:
      - monitoring
    depends_on:
      - edge-node-1
      - edge-node-2
      - edge-node-3
      - edge-node-4
      - edge-node-5
      - edge-node-6
      - edge-node-7
      - edge-node-8
      - edge-node-9
      - edge-node-10
      - edge-node-11
      - edge-node-12

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: "Admin"
      GF_AUTH_DISABLE_LOGIN_FORM: "true"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: "/etc/grafana/provisioning/dashboards/telemetry.json"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - monitoring
    depends_on:
      - prometheus

networks:
  monitoring:
    driver: bridge
